<script>
(function () {
  const STORAGE_KEY = "ananem_fatura_v1";

  function temizleVeSayiyaCevir(deger) {
    if (!deger) return 0;
    deger = String(deger).trim().replace(/\s/g, "");

    if (deger.includes(".") && deger.includes(",")) {
      deger = deger.replace(/\./g, "").replace(",", ".");
    } else if (deger.includes(",")) {
      deger = deger.replace(",", ".");
    }

    const n = Number(deger);
    return isNaN(n) ? 0 : n;
  }

  function formatTL(n) {
    return n.toLocaleString("tr-TR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }) + " â‚º";
  }

  function hesapla() {
    let e = 0, s = 0;
    document.querySelectorAll(".elektrik").forEach(i => e += temizleVeSayiyaCevir(i.value));
    document.querySelectorAll(".su").forEach(i => s += temizleVeSayiyaCevir(i.value));
    document.getElementById("elektrikToplam").textContent = formatTL(e);
    document.getElementById("suToplam").textContent = formatTL(s);
    document.getElementById("genelToplam").textContent = formatTL(e + s);
  }

  function kaydet() {
    const vals = [...document.querySelectorAll("tbody input")].map(i => i.value);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(vals));
  }

  function yukle() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const vals = JSON.parse(raw);
    [...document.querySelectorAll("tbody input")].forEach((i, idx) => {
      if (vals[idx] !== undefined) i.value = vals[idx];
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    yukle();
    hesapla();

    document.querySelectorAll("tbody input").forEach(i => {
      i.addEventListener("input", function () {
        hesapla();
        kaydet();
      });
    });
  });
})();
</script>
