<script>
  const STORAGE_KEY = "ananem_fatura_kayit_v1";

  function temizleVeSayiyaCevir(deger) {
    if (!deger) return 0;
    deger = deger.toString().trim().replace(/\s/g, "");

    // 1.234,56 => 1234.56
    if (deger.includes(".") && deger.includes(",")) {
      deger = deger.replace(/\./g, "").replace(",", ".");
    } else {
      // 12,34 => 12.34
      if (deger.includes(",")) deger = deger.replace(",", ".");
      // 12.34 => 12.34 (aynen)
    }

    const sayi = Number(deger);
    return isNaN(sayi) ? 0 : sayi;
  }

  function formatTL(sayi) {
    return sayi.toLocaleString("tr-TR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }) + " ₺";
  }

  function hesaplaToplamlar() {
    let toplamElektrik = 0;
    let toplamSu = 0;

    document.querySelectorAll(".elektrik").forEach(inp => {
      toplamElektrik += temizleVeSayiyaCevir(inp.value);
    });
    document.querySelectorAll(".su").forEach(inp => {
      toplamSu += temizleVeSayiyaCevir(inp.value);
    });

    document.getElementById("elektrikToplam").textContent = formatTL(toplamElektrik);
    document.getElementById("suToplam").textContent = formatTL(toplamSu);
    document.getElementById("genelToplam").textContent = formatTL(toplamElektrik + toplamSu);
  }

  function kaydet() {
    const inputs = Array.from(document.querySelectorAll("tbody input[type='text']"));
    const data = inputs.map(i => i.value || "");
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      // iOS bazen storage kapatabiliyor; sessiz geçiyoruz
      console.log("Kayıt yapılamadı:", e);
    }
  }

  function yukle() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);

      const inputs = Array.from(document.querySelectorAll("tbody input[type='text']"));
      inputs.forEach((inp, idx) => {
        if (data[idx] !== undefined) inp.value = data[idx];
      });
    } catch (e) {
      console.log("Yükleme yapılamadı:", e);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    yukle();
    hesaplaToplamlar();

    // Her değişiklikte kaydet + gerekiyorsa hesapla
    document.querySelectorAll("tbody input[type='text']").forEach(inp => {
      inp.addEventListener("input", () => {
        if (inp.classList.contains("elektrik") || inp.classList.contains("su")) {
          hesaplaToplamlar();
        }
        kaydet();
      });
    });

    // iOS’ta “kapatma/arka plana alma” için ekstra güvence
    window.addEventListener("pagehide", kaydet);
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") kaydet();
    });
  });
</script>
